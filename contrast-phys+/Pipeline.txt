å¥½é—®é¢˜ï¼è®©æˆ‘è¯¦ç»†æ¢³ç†æ•´ä¸ª pipelineï¼Œå¹¶å¯¹æ¯” paper å’Œ GitHub åŸå§‹å®ç°ã€‚

[4 tools called]

éå¸¸å¥½çš„é—®é¢˜ï¼è®©æˆ‘è¯¦ç»†æ¢³ç†æ•´ä¸ª pipelineï¼Œå¹¶å¯¹æ¯” paper/GitHub åŸå§‹å®ç°ã€‚

---

## ğŸ“‹ å®Œæ•´ Pipeline æ¢³ç†

### **Step 1: è§†é¢‘è¾“å…¥ â†’ æ¨¡å‹æ¨ç†**

```python
è¾“å…¥: è§†é¢‘å¸§ [T, H, W, C]  
      T = 300 å¸§ï¼ˆ10ç§’ @ 30fpsï¼‰
      H = W = 128 (é¢„å¤„ç†åçš„äººè„¸å°ºå¯¸)
      C = 3 (RGB)

é¢„å¤„ç†: [T, H, W, C] -> [1, C, T, H, W]  # è½¬æ¢ä¸ºæ¨¡å‹è¾“å…¥æ ¼å¼

æ¨¡å‹: PhysNet(x)
      â†“
è¾“å‡º: ST-rPPG block [1, 5, T]
      5 = S*S+1ï¼Œå…¶ä¸­ S=2ï¼ˆç©ºé—´ç»´åº¦ï¼‰
      - å‰ 4 ä¸ªé€šé“: 4 ä¸ªç©ºé—´ä½ç½®çš„ rPPG ä¿¡å·
      - ç¬¬ 5 ä¸ªé€šé“: ç©ºé—´å¹³å‡åçš„ rPPG ä¿¡å·ï¼ˆè¿™æ˜¯æˆ‘ä»¬è¦ç”¨çš„ï¼‰
```

**ä»£ç ä½ç½®**: `PhysNetModel.py` ç¬¬ 104-112 è¡Œ
```python
x = self.end(x)  # (B, 1, T, S, S), ST-rPPG block
x_list = []
for a in range(self.S):
    for b in range(self.S):
        x_list.append(x[:,:,:,a,b])  # 4ä¸ªç©ºé—´ä½ç½®
x = sum(x_list)/(self.S*self.S)  # ç©ºé—´å¹³å‡
X = torch.cat(x_list+[x], 1)  # [B, 5, T]
```

---

### **Step 2: æå– rPPG ä¿¡å·ï¼ˆWaveformï¼‰**

```python
æ¨¡å‹è¾“å‡º: [1, 5, T]

æå–æœ€åä¸€ä¸ªé€šé“ï¼ˆç©ºé—´å¹³å‡ä¿¡å·ï¼‰:
rppg_raw = output[:, -1, :]  # shape: [T]
         = output[:, 4, :]    # ç¬¬5ä¸ªé€šé“ï¼ˆç´¢å¼•4ï¼‰
```

**è¿™å°±æ˜¯ "waveform"** - åŸå§‹ rPPG ä¿¡å·ï¼Œé•¿åº¦ T=300ã€‚

**ä»£ç ä½ç½®**: `live_predict_webcam.py` ç¬¬ 308 è¡Œ
```python
rppg = output[:, -1, :]  # æå–æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„ rPPG
```

---

### **Step 3: å¸¦é€šæ»¤æ³¢**

```python
è¾“å…¥: rppg_raw [T]

Butterworth å¸¦é€šæ»¤æ³¢ (0.6-4 Hz = 36-240 BPM):
rppg_filtered = butter_bandpass(rppg_raw, lowcut=0.6, highcut=4, fs=30)
               â†“
è¾“å‡º: rppg_filtered [T]  # æ»¤æ³¢åçš„ rPPG ä¿¡å·
```

**ç›®çš„**: å»é™¤å¿ƒç‡èŒƒå›´å¤–çš„å™ªå£°ï¼ˆä¿ç•™ 36-240 BPM çš„ç”Ÿç†ä¿¡å·ï¼‰ã€‚

---

### **Step 4: FFT è½¬æ¢ â†’ é¢‘è°±**

```python
è¾“å…¥: rppg_filtered [T]

Step 4.1: åŠ  Hann çª—ï¼ˆå‡å°‘é¢‘è°±æ³„éœ²ï¼‰
sig_windowed = rppg_filtered * hann_window(T)

Step 4.2: FFT å˜æ¢
sig_f = np.abs(fft(sig_windowed))  # FFT å¹…åº¦è°±ï¼Œä¸æ˜¯ PSDï¼
       â†“
è¾“å‡º: sig_f [T]  # é¢‘åŸŸè¡¨ç¤ºï¼ˆå•è¾¹è°±ï¼Œåªç”¨å‰ä¸€åŠï¼‰
```

**å…³é”®åŒºåˆ«**ï¼š
- **GitHub åŸå§‹ä»£ç ç”¨çš„æ˜¯ FFT å¹…åº¦è°±** (`np.abs(fft(sig))`)
- **ä¸æ˜¯ PSD**ï¼ˆPSD = `|FFT|^2`ï¼‰
- **SNR_get å‡½æ•°ç”¨çš„æ˜¯ PSD** (`np.abs(fft(sig))**2`)ï¼Œä½† HR ä¼°è®¡ç”¨çš„æ˜¯å¹…åº¦è°±

**ä»£ç ä½ç½®**: `utils_sig.py` ç¬¬ 34-46 è¡Œ
```python
def hr_fft(sig, fs, harmonics_removal=True):
    # get heart rate by FFT
    # return both heart rate and PSD  â† æ³¨é‡Šæœ‰è¯¯ï¼Œå®é™…è¿”å›çš„æ˜¯å¹…åº¦è°±
    
    sig = sig.reshape(-1)
    sig = sig * signal.windows.hann(sig.shape[0])
    sig_f = np.abs(fft(sig))  # â† FFT å¹…åº¦è°±ï¼Œä¸æ˜¯ PSD
```

---

### **Step 5: å³°å€¼æ£€æµ‹ â†’ å¿ƒç‡**

```python
è¾“å…¥: sig_f [T]  # FFT å¹…åº¦è°±

Step 5.1: é¢‘ç‡æ©ç ï¼ˆåªä¿ç•™ [0.6, 4] Hzï¼‰
sig_f[0:low_idx] = 0
sig_f[high_idx:] = 0

Step 5.2: æ‰¾é¢‘è°±å³°å€¼
peak_idx = find_peaks(sig_f)  # æ‰¾æ‰€æœ‰å³°å€¼
sort_idx = argsort(sig_f[peak_idx])[::-1]  # æŒ‰åŠŸç‡é™åºæ’åº

Step 5.3: å– Top-2 å³°å€¼
peak_idx1 = peak_idx[sort_idx[0]]  # æœ€å¤§å³°å€¼
peak_idx2 = peak_idx[sort_idx[1]]  # ç¬¬äºŒå¤§å³°å€¼

Step 5.4: è½¬æ¢ä¸ºå¿ƒç‡ (BPM)
f_hr1 = peak_idx1 / T * fs  # é¢‘ç‡ (Hz)
hr1 = f_hr1 * 60            # å¿ƒç‡ (BPM)

Step 5.5: è°æ³¢å»é™¤ï¼ˆå¯é€‰ï¼‰
if harmonics_removal:
    if |hr1 - 2*hr2| < 10:  # hr1 æ˜¯ hr2 çš„äºŒå€è°æ³¢
        hr = hr2             # é€‰æ‹©åŸºé¢‘
    else:
        hr = hr1             # å¦åˆ™é€‰æœ€å¤§å³°å€¼
else:
    hr = hr1
```

---

## ğŸ” ä¸ Paper/GitHub å¯¹æ¯”

### **1. FFT vs PSD**

| é¡¹ç›® | GitHub åŸå§‹ä»£ç  | Paper é€šå¸¸è¯´æ³• |
|------|----------------|--------------|
| **HR ä¼°è®¡** | FFT å¹…åº¦è°± (`np.abs(fft)`) | "FFT" æˆ– "frequency-domain analysis" |
| **SNR è®¡ç®—** | PSD (`np.abs(fft)**2`) | PSD (Power Spectral Density) |
| **æ³¨é‡Š** | "return PSD" âŒ ä¸å‡†ç¡® | - |

**ç»“è®º**: GitHub ä»£ç ç”¨çš„æ˜¯ **FFT å¹…åº¦è°±**ï¼Œæ³¨é‡Šè¯´ PSD æ˜¯é”™çš„ã€‚

---

### **2. è°æ³¢å»é™¤é€»è¾‘**

```python
if np.abs(hr1 - 2*hr2) < 10:  # å¦‚æœ hr1 â‰ˆ 2*hr2
    hr = hr2  # é€‰æ‹© hr2ï¼ˆè®¤ä¸º hr1 æ˜¯è°æ³¢ï¼‰
else:
    hr = hr1  # å¦åˆ™é€‰ hr1
```

**é—®é¢˜**: 
- è¿™ä¸ªé€»è¾‘å¤ªç®€å•ï¼Œå®¹æ˜“è¯¯åˆ¤
- ä½ çš„ 60s æµ‹è¯•å°±è¯¯åˆ¤äº†ï¼š108 BPMï¼ˆTop-1ï¼‰å’Œ 60 BPMï¼ˆTop-2ï¼‰è¢«è®¤ä¸ºæ˜¯è°æ³¢å…³ç³»ï¼Œé€‰äº† 60 BPMï¼Œä½†çœŸå® HR æ˜¯ 90 BPM

---

### **3. æˆ‘ä»¬çš„æ”¹è¿›ï¼ˆParabolic Interpolationï¼‰**

```python
# åŸå§‹ hr_fft: åªç”¨ FFT bin çš„æ•´æ•°ç´¢å¼•
hr = peak_idx / T * fs * 60

# hr_fft_parabolic: æŠ›ç‰©çº¿æ’å€¼ï¼Œå¾—åˆ°å°æ•°ç´¢å¼•
peak_idx_refined = peak_idx + delta  # delta æ˜¯æ’å€¼ä¿®æ­£
hr = peak_idx_refined / T * fs * 60
```

**ä¼˜åŠ¿**: æ‰“ç ´ FFT é‡åŒ–ç½‘æ ¼ï¼ˆä» 2 BPM åˆ†è¾¨ç‡ â†’ 0.1 BPMï¼‰ã€‚

---

## ğŸ“Š å®Œæ•´æ•°æ®æµæ€»ç»“

```
è§†é¢‘å¸§ [T=300, H=128, W=128, C=3]
   â†“ (é¢„å¤„ç†)
[1, C=3, T=300, H=128, W=128]
   â†“ (PhysNet æ¨¡å‹)
ST-rPPG block [1, 5, T=300]
   â†“ (å–ç¬¬5ä¸ªé€šé“)
rPPG_raw [300]  â† è¿™æ˜¯ "waveform"ï¼ˆåŸå§‹ï¼‰
   â†“ (Butterworth å¸¦é€šæ»¤æ³¢ 0.6-4 Hz)
rPPG_filtered [300]  â† è¿™æ˜¯æ»¤æ³¢åçš„ waveform
   â†“ (åŠ  Hann çª—)
rPPG_windowed [300]
   â†“ (FFT)
FFT_magnitude [300]  â† FFT å¹…åº¦è°±ï¼ˆä¸æ˜¯ PSDï¼‰
   â†“ (é¢‘ç‡æ©ç  + å³°å€¼æ£€æµ‹)
peak_idx1, peak_idx2
   â†“ (è½¬æ¢ + è°æ³¢å»é™¤)
HR (BPM)  â† æœ€ç»ˆå¿ƒç‡ä¼°è®¡
```

---

## âœ… å›ç­”ä½ çš„é—®é¢˜

1. **ç”¨çš„æ˜¯ FFT è¿˜æ˜¯ PSDï¼Ÿ**  
   â†’ **FFT å¹…åº¦è°±** (`np.abs(fft)`)ï¼Œä¸æ˜¯ PSD (`|fft|^2`)

2. **Waveform æ˜¯å“ªä¸€æ­¥è¾“å‡ºçš„ï¼Ÿ**  
   â†’ **Step 2** çš„ `rppg_raw [T]` æ˜¯åŸå§‹ waveform  
   â†’ **Step 3** çš„ `rppg_filtered [T]` æ˜¯æ»¤æ³¢å waveform

3. **å¦‚ä½•è½¬æ¢æˆå¿ƒç‡ï¼Ÿ**  
   â†’ FFT â†’ é¢‘è°±å³°å€¼æ£€æµ‹ â†’ é¢‘ç‡è½¬ BPM â†’ è°æ³¢å»é™¤

4. **æ˜¯å¦æŒ‰ paper è¯´çš„ï¼Ÿ**  
   â†’ åŸºæœ¬ä¸€è‡´ï¼Œä½† paper é€šå¸¸åªè¯´"FFT-based HR estimation"ï¼Œä¸ä¼šè¯¦ç»†è¯´æ˜¯å¹…åº¦è°±è¿˜æ˜¯ PSD  
   â†’ **æ³¨é‡Šè¯¯å¯¼**ï¼šä»£ç æ³¨é‡Šè¯´ PSDï¼Œå®é™…æ˜¯å¹…åº¦è°±

ä½ ç°åœ¨æ¸…æ¥šæ•´ä¸ªæµç¨‹äº†å—ï¼Ÿ